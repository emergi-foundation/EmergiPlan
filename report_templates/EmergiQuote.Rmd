---
title: "Your Emergi Offer"
author: "Emergi"
date: '`r format(Sys.Date(), "%d %B %Y")`'
tables: true
always_allow_html: true
output:
  html_document:
    toc: yes
    toc_depth: 1
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    latex_engine: lualatex
    template: emergi_template.tex
params:
  survey: EmergiQuotetree
  email_address: "ahk@live.unc.edu"
  zip_code: "00000"
  utility: "Duke Energy Progress"
  last_bill_kWh: 1035
  bill_period_start: "9/1/2020"
  bill_period_end: "10/1/2020"
  has_gas: "No"
  valid_for_days: 10
  service_address: "610 Perkins Drive"
  own_or_rent: "Rent"
  solar_rate: .15
  co2e_avoided: 6
  vegan_equivalents: 5
  tree_equivalents: 110
  led_equivalents: 250
  compost_equivalents: 10000
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(RColorBrewer)
library(png)
library(kableExtra)
library(tidyverse)
set.seed(1)
```

```{r results, include=FALSE, echo=FALSE}
results <- c()
results$price=139.29
results$expected_usage=1065
results$base_rate=0.14
results$savings_rate=0.11
results$escalator=0.02
results$utility_escalator=0.03
results$state="NC"

is_other_utility=ifelse(params$utility=="Other",TRUE,FALSE)

is_not_eligible=ifelse(results$state!="NC",TRUE,FALSE)
is_other_utility=FALSE

is_other_utility=ifelse(is_not_eligible,FALSE,is_other_utility)
```

<!-- Calculating Predicted Energy Usage / Month -->
<!-- Assuming no gas house, during month of September, Raleigh-Durham area -->

```{r usage_calc, include=FALSE}
# aggregate from hourly % curve estimate
#% usage in each month (no gas)
monthly_pcts <- list(
"jan"=.111,
"feb"=.092,
"march"=.08,
"apr"=.058,
"may"=.063,
"jun"=.086,
"jul"=.104,
"aug"=.101,
"sep"=.084,
"oct"=.061,
"nov"=.066,
"dec"=.094)

# month_num, month_pct, daily_pct, num_days
monthly_stats <- data.frame(
  month_num=1:12,
  monthly_pct=unlist(monthly_pcts)
)

monthly_stats$num_days <- 365.25/12 # improve this to be exact using lubridate

monthly_stats$daily_pct <- monthly_stats$monthly_pct / monthly_stats$num_days

#converting dates from str 
strDates <- c(params$bill_period_start, params$bill_period_end)
dates <- as.Date(strDates, "%m/%d/%y")

estimate_from_month <- lubridate::month(dates[1])

stats_for_billing_period <- monthly_stats[estimate_from_month,]

#calculating total days over billing period
# lubridate
# tidyverse
days_passed <- as.numeric(difftime(dates[2], dates[1], units = "days"))

#calculating energy used per day based on past bill
avg_daily_use <- (as.numeric(params$last_bill_kWh)/(days_passed-1))

#energy used per day divided by daily_pct
implied_annual <- as.numeric(avg_daily_use / stats_for_billing_period$daily_pct)

#finding yearly total using months% and avg_use
## convert to a column of monthly_stats with monthly totals
# yearly_total <- (jan*implied_annual)+(feb*implied_annual)+(march*implied_annual)+(apr*implied_annual)+(may*implied_annual)+(jun*implied_annual)+(jul*implied_annual)+(aug*implied_annual)+(sep*implied_annual)+(oct*implied_annual)+(nov*implied_annual)+(dec*implied_annual)
monthly_stats$expected_usage <- monthly_stats$monthly_pct * implied_annual

monthly <- round(implied_annual / 12, 0)
monthly_ceiling <- 100*ceiling(monthly/100)


```

**Your Monthly Predicted Usage:**
**`r monthly` kWh**  

**Rounded Up: `r monthly_ceiling` kWh**  

**Average Daily Use: `r avg_daily_use` kWh**  

**Days Passed: `r days_passed-1` days**

**Implied Annual: `r implied_annual` kWh**


#### &nbsp;

#### Your Future With Emergi { #top }

`r if(is_not_eligible){"Thanks for your interest in Emergi! We are not yet serving customers in your area, but we will contact you when service is available for signup. We have included a quote for the typical American home below so that you know what to expect. Please activate your service at any time to be ready to go when solar becomes available to your home."}else{""}`

`r if(is_other_utility){"Thanks for submitting! You will recieve an email confirmation shortly, and we will send you a copy of your quote within a day. We have included a quote for the typical American home below so that you know what to expect. You may activate your service in advance to be ready to go when solar becomes available to your home."}else{""}`


**$`r results$price`/month**

This is your personalized offer for 100% solar energy, created using the information you provided, typical usage for your area, and rates from your utility. Details and an explaination are below.

<a target="_blank" href="http://www.google.com/">
  <button id="activate.button" type="button" class="btn btn-large btn-default action-button">Activate My Service</button>
</a>

#### &nbsp;

***

#### &nbsp;

```{r quote-table, echo=FALSE, include=TRUE, results="asis"}
# Set a named vector for dynamic header
table_title <- paste0("Quote Details for ",params$email_address)

# create vector with colspan
myHeader <- c(4)

# set vector names 
names(myHeader) <- c(table_title)

quote_tibble <- tibble(
  Labels = c("Zip Code",
             "Utility",
             "Date Prepared",
             "Valid Until",
             "Services Provided",
             "Monthly Bill",
             "Solar Rate",
             "Expected Usage",
             "Base Rate",
             "Savings Rate",
             "Escalator",
             "Tonnes CO2e Avoided",
             "Vegan Equivalents",
             "Tree Equivalents",
             "LED Equivalents",
             "Compost Equivalents"),
  Values = c(params$zip_code,
             params$utility,
             1,
             1,
             "Grid Solar<br>Bill Smoothing<br>Rate Optimization",
             results$price,
             params$solar_rate,
             results$expected_usage,
             results$base_rate,
             results$savings_rate,
             results$escalator,
             params$co2e_avoided,
             params$vegan_equivalents,
             params$tree_equivalents,
             params$led_equivalents,
             params$compost_equivalents
             ),
  Format = c("character (unless used in calculations...)", 
             "factor(?)",
             "date (integer)",
             "date (integer)",
             "factor(?)",
             "numeric",
             "numeric",
             "numeric (unless consistently rounded in calculations)",
             "numeric",
             "numeric",
             "numeric",
             "numeric (unless consistently rounded)",
             "numeric (unless consistently rounded)",
             "numeric (unless consistently rounded)",
             "numeric (unless consistently rounded)",
             "numeric (unless consistently rounded)")
)
quote_tibble$shiny_format <- typeof(quote_tibble$Values)

quote_table <- knitr::kable(quote_tibble,
                            booktabs=T,
                            align='c',
                            escape=FALSE
               ) %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::column_spec(c(2), bold=T) %>% 
  add_header_above(myHeader)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
quote_table
```

**What does this mean?**

Your monthly cost of $`r results$price` assumes that you will use an average of `r results$expected_usage` kWh per month over the course of each year. Your Emergi escalator of `r results$escalator`% per year is how we account for the gradual rise of utility costs (expected to be `r results$utility_escalator`%/year according to the U.S. Energy Information Administration) as well as inflation.

**What if I use more/less than my expected usage?**

If you use more than your expected monthly usage over the course of the year, Emergi will charge for your additional usage at your base rate of $`r results$base_rate`/kWh. If you use less than your expected monthly usage over the course of the year, you will earn savings at a rate of $`r results$savings_rate`/kWh. Emergi will true up your account annually.

<a target="_blank" href="http://www.google.com/">
  <button id="activate.button" type="button" class="btn btn-large btn-default action-button">Activate My Service</button>
</a>

#### The Inputs You Provided

```{r inputs-table, echo=FALSE, include=TRUE, results="asis"}
# Set a named vector for dynamic header
table_title <- paste0("Quote Inputs for ",params$email_address)

# create vector with colspan
myHeader <- c(3)

# set vector names 
names(myHeader) <- c(table_title)

inputs_tibble <- tibble(
  Labels = c("Prepared For",
             "Zip Code",
             "Utility",
             "Last Bill Usage (kWh)",
             "Last Bill Start Date",
             "Last Bill End Date",
             "Use Gas?", 
             "Service Address", 
             "Own vs Rent"
             ),
  Values = c(params$email_address,
             params$zip_code,
             params$utility,
             params$last_bill_kWh,
             params$bill_period_start,
             params$bill_period_end,
             params$has_gas, 
             params$service_address, 
             params$own_or_rent
             ),
  Format = c("character + whatever symbol we use to bypass the verification process?",
             "character (unless used in calculations...)",
             "character",
             "character",
             "character",
             "character",
             "character",
             "character",
             "character")
)

inputs_table <- knitr::kable(inputs_tibble,
                            booktabs=T,
                            align='c',
                            escape=FALSE
               ) %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::column_spec(c(2), bold=T) %>% 
  add_header_above(myHeader)
  # kableExtra::kable_styling(latex_options = c("striped"), #,"hold_position"
                            # position="center")
inputs_table
```